<html>

<head></head>


<body>



    <script>

        /**
         * 
         * 数据格式 {
         *   phone:'15801576998',
         *   email:'xiangwenhu@hotmail.com'     * 
         * }   
         * 
         *  配置的验证格式
         * {
         *    email:{
         *              rules: 'require|phone'
         *              messages:{
         *                  require:'必填项',
         *                  phone:'请输入正确的手机号'
         *              }
         *          } 
         * }
         * 
         */

        class Validator {

            /** 添加验证规则
             {
                name:'phone',
                regex:'',
                method:function (val) {
                    return  100 >= val;
                }
                message:'数值必须大于100'
              }
              
            **/
            static addRule(rule) {
                if (rule && rule.name) {
                    Validator.rules[rule.name] = rule
                }
            }
            /**验证数据
             * */
            static validate(data, mapping) {
                let rules = Validator.rules,
                    ret = {
                        status: true
                    }
                if (mapping && mapping instanceof Object) {
                    for (let m of Object.keys(mapping)) {
                        let curMsgs = mapping[m].messages, //获取自定义的消息
                            val = Validator.getPropVal(data, m)
                        //遍历所有的rule，格式为 require|phone
                        mapping[m].rules.split('\|').every(r => (ret = Validator.validateStr(val, r, curMsgs ? curMsgs[r] : undefined)).status ? true : false)
                        if (!ret.status) {
                            return ret
                        }
                    }
                }
                return ret
            }

            //单条验证
            static validateStr(str, ruleName, msg) {
                let rule = Validator.rules[ruleName] //获得rule
                if (!rule) {
                    return {
                        status: false,
                        message: `未找到验证规则${ruleName}`
                    }
                }
                let pass = rule.method(str)
                if (pass) {
                    return { status: true }
                }
                return {
                    status: false,
                    message: msg || rule.message ||Validator.defaultMessages[ruleName] || `未定义规则为${ruleName}的消息`
                }
            }

            static getPropVal(data, propName) {
                let val = data
                propName.split('.').forEach(function (v, i) {
                    val = val[v]
                })
                return val
            }
        }

        Validator.rules = {
            require: {
                method: str => !(str == undefined || str.trim() == "")
            },
            phone: {
                method: str => /^1(3\d|4(7)|5(0|1|2|3|5|6|7|8|9)|68|7(0|3|6|7|8)|8\d)\d{8}$/.test(str),
                message:'我的手机号码？？？'
            },
            province: {
                method: str => str.length <= 5
            }
        }

        Validator.defaultMessages = {
            require: '必填项',
            phone: '请输入正确的手机号码',
            age: '请输入正确的年龄'
        }


        let data = {
            phone: '',
            address: {
                province: '打打大大大省'
            },
            user:{
                family:{
                    fatherPhone:'asdasdasdasdas'
                }
            }
        }, vs = {
            /*'phone': {
                rules: 'require|phone',
                messages: {
                    require: '必须有'
                }
            }, 
            'address.province': {
                rules: 'require|province',
                messages: {
                    province: '省名字过长'
                }
            }
            */
            'user.family.fatherPhone':{
                rules:'phone'                
            }
        }



        let result = Validator.validate(data, vs)

        console.log(JSON.stringify(result))



    </script>




</body>



</html>